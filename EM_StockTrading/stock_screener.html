<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stock Screener</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 4px 8px; text-align: right; }
    th { cursor: pointer; background: #f2f2f2; }
    input, select { margin: 4px; }
  </style>
</head>
<body>

  <h2>Stock CSV Viewer</h2>

  <div>
    <label>CSV URL:</label>
    <input type="text" id="csvUrl" size="80"
      value="https://raw.githubusercontent.com/edmilinski/edmilinski.github.io/main/EM_StockTrading/Russell_1000_Prices.csv">
    <button onclick="loadCsv()">Load</button>
  </div>

  <div>
    <label>Filter:</label>
    <select id="filterColumn"></select>
    <select id="filterOp">
      <option value=">">&gt;</option>
      <option value="<">&lt;</option>
      <option value="=">=</option>
    </select>
    <input type="number" id="filterValue" placeholder="Value">
    <button onclick="applyFilter()">Apply</button>
    <button onclick="resetFilter()">Reset</button>
  </div>

  <table id="dataTable"></table>

  <script>
    let fullData = [];
    let currentSortCol = null;
    let sortAsc = true;

    function loadCsv() {
      const url = document.getElementById('csvUrl').value;
      Papa.parse(url, {
        download: true,
        header: true,
        complete: (results) => {
          fullData = results.data.filter(row => row.symbol); // remove empty
          renderTable(fullData);
          populateFilterColumns(Object.keys(fullData[0]));
        }
      });
    }

    function renderTable(data) {
        const table = document.getElementById('dataTable');
        if (!data.length) return;

        const headers = Object.keys(data[0]);
        let html = '<thead><tr>';
        headers.forEach(h => {
            html += `<th onclick="sortBy('${h}')">${h}</th>`;
        });
        html += '</tr></thead><tbody>';

        data.forEach(row => {
            html += '<tr>';
            headers.forEach((h, i) => {
            if (i === 0) {
                // Make first column (ticker) a link
                const ticker = row[h];
                html += `<td><a href="stock_chart.html?ticker=${encodeURIComponent(ticker)}" target="stock_chart">${ticker}</a></td>`;
            } else {
                html += `<td>${row[h] ?? ''}</td>`;
            }
            });
            html += '</tr>';
        });

        html += '</tbody>';
        table.innerHTML = html;
    }


    function populateFilterColumns(columns) {
      const select = document.getElementById('filterColumn');
      select.innerHTML = columns.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function applyFilter() {
      const col = document.getElementById('filterColumn').value;
      const op = document.getElementById('filterOp').value;
      const val = parseFloat(document.getElementById('filterValue').value);
      if (isNaN(val)) return alert("Enter a valid number");

      const filtered = fullData.filter(row => {
        const cell = parseFloat(row[col]);
        if (isNaN(cell)) return false;
        if (op === '>') return cell > val;
        if (op === '<') return cell < val;
        if (op === '=') return cell === val;
      });

      renderTable(filtered);
    }

    function resetFilter() {
      renderTable(fullData);
    }

    function sortBy(col) {
      if (currentSortCol === col) sortAsc = !sortAsc;
      else { currentSortCol = col; sortAsc = true; }

      fullData.sort((a, b) => {
        const va = parseFloat(a[col]) || a[col];
        const vb = parseFloat(b[col]) || b[col];
        if (va < vb) return sortAsc ? -1 : 1;
        if (va > vb) return sortAsc ? 1 : -1;
        return 0;
      });
      renderTable(fullData);
    }
  </script>

</body>
</html>
