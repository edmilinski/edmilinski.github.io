<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stock Screener</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }

    .table-container {
      max-height: 80vh; /* table scroll area */
      overflow-y: auto;
      border: 1px solid #ccc;
      margin-top: 10px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 4px 8px;
      text-align: right;
    }

    th {
      cursor: pointer;
      background: #f2f2f2;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    input, select { margin: 4px; }
    a { margin: 5px 5px; }
  </style>
</head>
<body>
  <div>
    <label>Filter:</label>
    <select id="filterColumn1"></select>
    <select id="filterOp1">
      <option value=">">greater</option>
      <option value="<">less</option>
      <option value="=">equal</option>
    </select>
    <input type="number" id="filterValue1" placeholder="Value" style="width: 50px;">

    <select id="filterColumn2"></select>
    <select id="filterOp2">
      <option value=">">greater</option>
      <option value="<">less</option>
      <option value="=">equal</option>
    </select>
    <input type="number" id="filterValue2" placeholder="Value" style="width: 50px;">

    <button onclick="applyFilter()">Apply</button>
    <button onclick="resetFilter()">Reset</button>
    <label>EST data time:</label> <label id="data_time"></label>
  </div>

  <div class="table-container">
    <table id="dataTable"></table>
  </div>

  <div>
    <label>CSV URL:</label>
    <input type="text" id="csvUrl" size="80"
      value="https://raw.githubusercontent.com/edmilinski/edmilinski.github.io/main/EM_StockTrading/Russell_1000_Prices.csv">
    <button onclick="loadCsv()">Load</button>
  </div>

  <script>
    let fullData = [];
    let data_time = ''
    let currentSortCol = null;
    let sortAsc = true;

    function loadCsv() {
      const url = document.getElementById('csvUrl').value;
      Papa.parse(url, {
        download: true,
        header: true,
        complete: (results) => {
          data_time = results.meta.fields[11]
          document.getElementById('data_time').innerHTML = data_time

          fullData = results.data.filter(row => row.symbol); // remove empty
          fullData.forEach(row => {
            row.ma_diff = (100 * (parseFloat(row.price) / parseFloat(row.mas_curr) - 1)).toFixed(1);
          });
          renderTable(fullData);
          populateFilterColumns();
        }
      });
    }

    function createFinvizLink(ticker) {
      return `<a href="https://finviz.com/quote.ashx?p=d&t=${ticker}" target="help_chart">.FV.</a>`;
    }

    function createGoogleLink(ticker) {
      return `<a href="https://www.google.com/finance/quote/${ticker}" target="help_chart">.G.</a>`;
    }

    function createGoogleNewsLink(ticker) {
      return `<a href="https://news.google.com/search?q=${ticker}+stock&hl=en-US&gl=US&ceid=US:en" target="help_chart">.GN.</a>`;
    }

    function renderTable(data) {
      const table = document.getElementById('dataTable');
      if (!data.length) return;

      const headers = ['symbol', 'change_pct', 'rsi', 'ma_diff', 'price'];
      let html = '<thead><tr>';
      headers.forEach(h => {
        html += `<th onclick="sortBy('${h}')">${h}</th>`;
      });
      html += '</tr></thead><tbody>';

      data.forEach(row => {
        html += '<tr>';
        headers.forEach((h, i) => {
          if(h == 'symbol') {
            const ticker = row[h];
            html += `<td><a href="stock_chart.html?ticker=${encodeURIComponent(ticker)}" target="stock_chart">${ticker}</a> ${createFinvizLink(ticker)} ${createGoogleLink(ticker)} ${createGoogleNewsLink(ticker)}</td>`;
          } else if(h == 'price') {
            price = ''
            if(row['price'])
              price = (parseInt(row['price'], 10) / 100).toFixed(2),
            html += `<td>${price}</td>`;
          } else {
            html += `<td>${row[h] ?? ''}</td>`;
          }
        });
        html += '</tr>';
      });

      html += '</tbody>';
      table.innerHTML = html;
    }

    function populateFilterColumns(columns) {
      const sel1 = document.getElementById('filterColumn1');
      const sel2 = document.getElementById('filterColumn2');
      columns = ['symbol', 'change_pct', 'rsi', 'ma_diff']
      const opts = ['<option value="">--ignore--</option>'].concat(columns.map(c => `<option value="${c}">${c}</option>`)).join('');
      sel1.innerHTML = opts;
      sel2.innerHTML = opts;
    }

    function applyFilter() {
      const col1 = document.getElementById('filterColumn1').value;
      const op1 = document.getElementById('filterOp1').value;
      const val1 = parseFloat(document.getElementById('filterValue1').value);

      const col2 = document.getElementById('filterColumn2').value;
      const op2 = document.getElementById('filterOp2').value;
      const val2 = parseFloat(document.getElementById('filterValue2').value);

      const filtered = fullData.filter(row => {
        let keep = true;

        if (col1 && !isNaN(val1)) {
          const cell = parseFloat(row[col1]);
          if (isNaN(cell)) keep = false;
          else if (op1 === '>' && !(cell > val1)) keep = false;
          else if (op1 === '<' && !(cell < val1)) keep = false;
          else if (op1 === '=' && !(cell === val1)) keep = false;
        }

        if (col2 && !isNaN(val2)) {
          const cell = parseFloat(row[col2]);
          if (isNaN(cell)) keep = false;
          else if (op2 === '>' && !(cell > val2)) keep = false;
          else if (op2 === '<' && !(cell < val2)) keep = false;
          else if (op2 === '=' && !(cell === val2)) keep = false;
        }

        return keep;
      });

      renderTable(filtered);
    }

    function resetFilter() {
      document.getElementById('filterColumn1').value = '';
      document.getElementById('filterValue1').value = '';
      document.getElementById('filterColumn2').value = '';
      document.getElementById('filterValue2').value = '';
      renderTable(fullData);
    }

    function sortBy(col) {
      if (currentSortCol === col) sortAsc = !sortAsc;
      else { currentSortCol = col; sortAsc = true; }

      fullData.sort((a, b) => {
        const va = parseFloat(a[col]) || a[col];
        const vb = parseFloat(b[col]) || b[col];
        if (va < vb) return sortAsc ? -1 : 1;
        if (va > vb) return sortAsc ? 1 : -1;
        return 0;
      });
      renderTable(fullData);
    }

    loadCsv();
  </script>

</body>
</html>